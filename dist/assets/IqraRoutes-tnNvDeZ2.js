const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/IqraTeaching-DN0Crwln.js","assets/index-NbX1JcnA.js","assets/index-D6FtVxwb.css","assets/IqraBookViewer-BWp-D6bf.js","assets/visuallyHidden-Dan1xhjv.js","assets/Edit-BL9613mr.js","assets/Delete-BBT7Eckp.js","assets/Tabs-BFpWoaKh.js","assets/KeyboardArrowRight-DO8ZDbbz.js","assets/Alert-CmfgxPu4.js","assets/Close-BMBH_CLD.js","assets/Dialog-DxCc320D.js","assets/DialogTitle-D-CYvDlS.js","assets/DialogContent-BKdfl9fq.js","assets/Stack-BFhCfF0v.js","assets/useThemeProps-DPqPURvD.js","assets/Button-BugPEW2g.js","assets/TextField-BvzYVYPy.js","assets/Select-DoWYHUS9.js","assets/isMuiElement-CyZXsiQS.js","assets/Close-D2ySPaYt.js","assets/Rating-DYENZGkn.js","assets/History-TrlvX2Hj.js","assets/Grid-D4usHc3i.js","assets/CardContent-GC4ifVzl.js","assets/People-CcVNbQB0.js","assets/ListItem-CES74IAT.js","assets/Stop-B23AusHG.js","assets/Snackbar-CkYnnWCh.js","assets/VideoCall-C1pAmZ6U.js","assets/ListItemAvatar-B8BjRCRl.js","assets/TeachingSession-LotSUjDZ.js"])))=>i.map(i=>d[i]);
import{h as C,i as D,k as _,ap as z,aq as W,ar as Q,as as X,at as F,au as Y,r as T,e as ee,j as a,w as se,l as M,av as G,aw as L,ax as te,ay as b,f as oe,$ as ne}from"./index-NbX1JcnA.js";const V="meetCredentials",re=async o=>{try{const r=C(D,V,o),e=await _(r);return e.exists()?e.data():null}catch(r){return console.error("Error getting Meet credentials:",r),null}},U=async(o,r)=>{try{const e=C(D,V,o);await z(e,{...r,updatedAt:new Date().toISOString()})}catch(e){throw console.error("Error storing Meet credentials:",e),e}},ae=o=>{if(!o||!o.expiresAt)return!1;const r=new Date(o.expiresAt).getTime()-5*60*1e3;return Date.now()<r},B="https://www.googleapis.com/calendar/v3",ce=["https://www.googleapis.com/auth/calendar","https://www.googleapis.com/auth/calendar.events"],J=async()=>{var k;const o=W(),r=o.currentUser;if(!r)throw new Error("User not authenticated");console.log("Getting stored credentials for user:",r.uid);const e=await re(r.uid);if(console.log("Stored credentials:",{...e,googleAccessToken:e!=null&&e.googleAccessToken?"[REDACTED]":null,googleRefreshToken:e!=null&&e.googleRefreshToken?"[REDACTED]":null}),e){if(ae(e))return console.log("Using stored credentials - still valid"),e.googleAccessToken;console.log("Stored credentials expired, refreshing token");try{const n=Q(void 0,"asia-southeast1"),l=X(n,"refreshGoogleToken");console.log("Calling refreshGoogleToken Cloud Function...");const s=await l();if(console.log("Token refresh result:",s.data?"Success":"Failed"),(k=s.data)!=null&&k.accessToken){const E={...e,googleAccessToken:s.data.accessToken,expiresAt:new Date(Date.now()+36e5).toISOString()};return console.log("Storing updated credentials"),await U(r.uid,E),s.data.accessToken}else console.log("No access token in refresh result")}catch(n){console.error("Error refreshing token:",n),console.log("Error details:",n.message,n.code,n.details)}}else console.log("No stored credentials found");console.log("No valid stored credentials, requesting new ones");const m=new F;ce.forEach(n=>m.addScope(n)),m.setCustomParameters({access_type:"offline",prompt:"consent",include_granted_scopes:"true"});try{const n={...o.currentUser};console.log("Current user before popup:",n.email);const l=await Y(o,m);console.log("Sign in result:",l.user.email);const s=F.credentialFromResult(l);if(console.log("Got credential:",s?"yes":"no"),console.log("Credential details:",{accessToken:s!=null&&s.accessToken?"[REDACTED]":null,refreshToken:s!=null&&s.refreshToken?"[REDACTED]":null,providerId:s==null?void 0:s.providerId,signInMethod:s==null?void 0:s.signInMethod}),!(s!=null&&s.accessToken))throw console.error("No access token in credential"),new Error("No access token received");const E={googleAccessToken:s.accessToken,googleRefreshToken:s.refreshToken||null,expiresAt:new Date(Date.now()+3600*1e3).toISOString(),associatedEmail:l.user.email};return console.log("Storing credentials:",{...E,googleAccessToken:"[REDACTED]",googleRefreshToken:E.googleRefreshToken?"[REDACTED]":null}),await U(n.uid,E),console.log("Credentials stored successfully"),o.currentUser.uid!==n.uid&&(console.log("Restoring original user"),await o.updateCurrentUser(n)),s.accessToken}catch(n){throw console.error("Error in getCalendarToken:",n),o.currentUser.uid!==r.uid&&await o.updateCurrentUser(r),n}},ie=async(o,r,e=60,m=[],k)=>{var n;try{console.log("Getting Calendar token...");const l=await J();console.log("Calendar token obtained:",l?"Token received":"No token");const s={summary:o,start:{dateTime:r,timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},end:{dateTime:new Date(new Date(r).getTime()+e*6e4).toISOString(),timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},attendees:[{email:k,organizer:!0},...m.map(O=>({email:O,responseStatus:"accepted"}))],conferenceData:{createRequest:{requestId:`${Date.now()}_${Math.random().toString(36).substring(7)}`,conferenceSolutionKey:{type:"hangoutsMeet"},conferenceDataVersion:1}},guestsCanModify:!1,guestsCanInviteOthers:!1,guestsCanSeeOtherGuests:!0,anyoneCanAddSelf:!1,sendUpdates:"all"};console.log("Creating Calendar event with Meet...");const E=`${B}/calendars/primary/events?conferenceDataVersion=1&sendNotifications=true`;console.log("Calendar API URL:",E);const x=await fetch(E,{method:"POST",headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"},body:JSON.stringify(s)});console.log("Calendar API response status:",x.status);const R=await x.text();if(console.log("Calendar API response text:",R),!x.ok){const O=JSON.parse(R);throw console.error("Calendar API error:",O),new Error(((n=O.error)==null?void 0:n.message)||"Failed to create Google Meet")}const I=JSON.parse(R);if(console.log("Calendar event created:",I),!I.hangoutLink)throw console.error("No hangoutLink in response:",I),new Error("Meet link not created");return{meetLink:I.hangoutLink,eventId:I.id,startTime:I.start.dateTime,endTime:I.end.dateTime}}catch(l){throw console.error("Error in createGoogleMeet:",l),l}},le=async o=>{var r;try{console.log("Getting Calendar token...");const e=await J();console.log("Calendar token obtained:",e?"Token received":"No token");const m=`${B}/calendars/primary/events/${o}`;console.log("Calendar API URL:",m);const k=await fetch(m,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});console.log("Calendar API response status:",k.status);const n=await k.text();if(console.log("Calendar API response text:",n),!k.ok&&k.status!==404){const l=JSON.parse(n);throw console.error("Calendar API error:",l),new Error(((r=l.error)==null?void 0:r.message)||"Failed to delete Google Meet")}return console.log("Calendar event deleted:",o),!0}catch(e){throw console.error("Error in deleteGoogleMeet:",e),e}},Z=T.createContext(null);function pe(){const o=T.useContext(Z);if(!o)throw new Error("useSession must be used within a SessionProvider");return o}function de({children:o}){const{currentUser:r}=ee(),[e,m]=T.useState(null),[k,n]=T.useState(null),[l,s]=T.useState(!0),[E,x]=T.useState(null);T.useEffect(()=>{s(!1)},[]);const R=async i=>{var d;try{const c=C(D,"classes",i),u=await _(c);if(!u.exists())throw new Error("Class not found");const g=u.data(),w=C(D,"courses",g.courseId),S=await _(w);if(!S.exists())throw new Error("Course not found");const f=S.data();let t=[];if(((d=g.studentIds)==null?void 0:d.length)>0){const P=g.studentIds.map(async y=>{try{const A=C(D,"users",y),p=await _(A);if(p.exists())return{id:y,...p.data()}}catch(A){console.error(`Error loading student ${y}:`,A)}return null});t=(await Promise.all(P)).filter(y=>y!==null)}const h={...g,id:i,course:{id:g.courseId,...f},students:t,studentIds:g.studentIds||[]};return n(h),h}catch(c){throw console.error("Error loading class data:",c),x(c.message),c}},H={activeSession:e,activeClass:k,startSession:async(i,d,c=1)=>{var u,g,w,S,f;try{x(null);const t=await R(i);if(!((g=(u=t==null?void 0:t.course)==null?void 0:u.iqraBooks)!=null&&g.includes(d)))throw new Error("Selected book is not in the course");const h={};(t.studentIds||[]).forEach(p=>{h[p]={currentPage:c,drawings:{},notes:{},assessment:{reading:0,pronunciation:0,memorization:0}}});let P=null;try{console.log("Creating Google Meet for session...");const p=((w=t.students)==null?void 0:w.map(K=>K.email))||[],$=`${t.name} - Iqra Session`;console.log("Meet details:",{meetTitle:$,studentEmails:p});const j=await ie($,new Date().toISOString(),60,p,r.email);console.log("Meet created successfully:",j),P={link:j.meetLink,eventId:j.eventId,startTime:j.startTime,endTime:j.endTime},console.log("Meet data prepared:",P)}catch(p){console.error("Failed to create Google Meet - Full error:",p),(S=p.message)!=null&&S.includes("has not been used in project")||(f=p.message)!=null&&f.includes("it is disabled")?console.warn("Google Calendar API not enabled - continuing without Meet"):console.error("Unexpected error creating Meet:",p)}const v={teacherId:r.uid,classId:i,date:new Date().toISOString(),startTime:new Date().toLocaleTimeString(),book:d,startPage:c,currentPage:c,studentProgress:h,status:"active",...P&&{meet:P}};console.log("Creating session with data:",v);const y=C(se(D,"sessions"));await z(y,v);const A={id:y.id,...v,classData:t};return console.log("Session created successfully:",A),m(A),A}catch(t){throw console.error("Error starting session:",t),x(t.message),t}},updateClassProgress:async i=>{if(!e)throw new Error("No active session");try{const d=C(D,"sessions",e.id);await M(d,{currentPage:i,endPage:i,studentProgress:e.studentProgress}),m(c=>({...c,currentPage:i,endPage:i}))}catch(d){throw console.error("Error updating class progress:",d),d}},saveDrawing:async(i,d,c)=>{if(!e)throw new Error("No active session");try{const u=C(D,"sessions",e.id),g=`studentProgress.${i}.drawings.${d}`;await M(u,{[g]:c}),m(w=>({...w,studentProgress:{...w.studentProgress,[i]:{...w.studentProgress[i],drawings:{...w.studentProgress[i].drawings,[d]:c}}}}))}catch(u){throw console.error("Error saving drawing:",u),u}},endSession:async i=>{var d;if(!e)throw new Error("No active session");try{const c=C(D,"sessions",e.id),u=`${e.book}-${new Date().toISOString().split("T")[0]}-${e.id.slice(-6)}`;if((d=e.meet)!=null&&d.eventId)try{await le(e.meet.eventId)}catch(S){console.error("Failed to delete Google Meet:",S)}await M(c,{status:"completed",endTime:new Date().toISOString(),sessionId:u,endPage:e.currentPage,feedback:{classNotes:i.classNotes,studentFeedback:Object.entries(i.studentFeedback).reduce((S,[f,t])=>{var h,P,v;return S[f]={...t,pageNotes:t.pageNotes||{},assessment:{reading:((h=t.assessment)==null?void 0:h.reading)||0,pronunciation:((P=t.assessment)==null?void 0:P.pronunciation)||0,memorization:((v=t.assessment)==null?void 0:v.memorization)||0},areasOfImprovement:t.areasOfImprovement||[],strengths:t.strengths||[],notes:t.notes||""},S},{})}});const g=C(D,"classes",e.classId),w=await _(g);if(w.exists()){const f={...w.data().studentProgress};Object.entries(i.studentFeedback).forEach(([t,h])=>{f[t]||(f[t]={sessions:[],assessments:[]}),f[t].assessments.push({sessionId:u,date:new Date().toISOString(),book:e.book,startPage:e.startPage,endPage:e.currentPage,assessment:h.assessment,pageNotes:h.pageNotes||{},areasOfImprovement:h.areasOfImprovement,strengths:h.strengths,notes:h.notes}),f[t].sessions.push({sessionId:u,date:new Date().toISOString(),book:e.book,startPage:e.startPage,endPage:e.currentPage})}),await M(g,{studentProgress:f})}m(null),n(null)}catch(c){throw console.error("Error ending session:",c),x(c.message),c}},loading:l,error:E};return a.jsx(Z.Provider,{value:H,children:o})}const q=G.lazy(()=>L(()=>import("./IqraTeaching-DN0Crwln.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30]))),ue=G.lazy(()=>L(()=>import("./IqraBookViewer-BWp-D6bf.js").then(o=>o.d),__vite__mapDeps([3,1,2,4]))),ge=G.lazy(()=>L(()=>import("./TeachingSession-LotSUjDZ.js"),__vite__mapDeps([31,1,2,3,4,16,23,27,26,19,11,12,13,21]))),N=()=>a.jsx(oe,{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",children:a.jsx(ne,{})}),he=()=>a.jsx(de,{children:a.jsxs(te,{children:[a.jsx(b,{path:"/",element:a.jsx(T.Suspense,{fallback:a.jsx(N,{}),children:a.jsx(q,{})})}),a.jsx(b,{path:"/teaching/:studentId",element:a.jsx(T.Suspense,{fallback:a.jsx(N,{}),children:a.jsx(q,{})})}),a.jsx(b,{path:"/book/:bookId",element:a.jsx(T.Suspense,{fallback:a.jsx(N,{}),children:a.jsx(ue,{})})}),a.jsx(b,{path:"/teach/:classId",element:a.jsx(T.Suspense,{fallback:a.jsx(N,{}),children:a.jsx(ge,{})})})]})}),ke=Object.freeze(Object.defineProperty({__proto__:null,default:he},Symbol.toStringTag,{value:"Module"}));export{ke as I,pe as u};
