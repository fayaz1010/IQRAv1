import{Y as ne,e as ie,r as d,w as y,i as p,x as k,y as A,z as N,j as s,f as c,T as u,I as L,am as E,a5 as W,a3 as le,h as H,k as de,l as ce,C as ue,E as me,a0 as he,a2 as T,a1 as pe}from"./index-NbX1JcnA.js";import{C as xe}from"./Container-Xllwi1gj.js";import{S as z}from"./Stack-BFhCfF0v.js";import{B as f}from"./Button-BugPEW2g.js";import{L as $}from"./Link-ByJX8nbe.js";import{H as G}from"./History-TrlvX2Hj.js";import{A as je}from"./Add-DJ7EsDaO.js";import{G as Y}from"./Grid-D4usHc3i.js";import{C as ge,a as fe}from"./CardContent-GC4ifVzl.js";import{m as Ie}from"./proxy-D2rYx3pK.js";import{W as Ce}from"./Edit-BL9613mr.js";import{C as M}from"./Delete-BBT7Eckp.js";import{D as ye}from"./Dialog-DxCc320D.js";import{D as be}from"./DialogTitle-D-CYvDlS.js";import{D as Se,a as ve}from"./DialogContent-BKdfl9fq.js";import{T as De,a as R}from"./Tabs-BFpWoaKh.js";import{T as b}from"./TextField-BvzYVYPy.js";import{A as J}from"./Autocomplete-D9MstP6g.js";import{L as we,a as ke}from"./ListItem-CES74IAT.js";import{L as Ae}from"./ListItemAvatar-B8BjRCRl.js";import"./useThemeProps-DPqPURvD.js";import"./KeyboardArrowRight-DO8ZDbbz.js";import"./Select-DoWYHUS9.js";import"./isMuiElement-CyZXsiQS.js";import"./Close-BMBH_CLD.js";const U=({children:m,value:i,index:x,...S})=>s.jsx("div",{role:"tabpanel",hidden:i!==x,id:`class-tabpanel-${x}`,...S,children:i===x&&s.jsx(c,{sx:{p:3},children:m})}),es=()=>{const m=ne(),{currentUser:i}=ie(),[x,S]=d.useState([]),[I,K]=d.useState([]),[j,Q]=d.useState([]),[X,q]=d.useState(!1),[g,v]=d.useState(null),[C,O]=d.useState(0),[r,h]=d.useState({name:"",description:"",courseId:null,studentIds:[]}),[B,l]=d.useState("");d.useEffect(()=>{D(),Z(),V()},[i]);const D=async()=>{try{const e=y(p,"classes"),t=k(e,A("teacherId","==",i.uid)),a=await N(t),o=[];a.forEach(n=>{o.push({id:n.id,...n.data()})}),S(o)}catch(e){console.error("Error fetching classes:",e),l("Failed to load classes")}},Z=async()=>{try{const e=y(p,"courses"),t=k(e,A("teacherId","==",i.uid)),a=await N(t),o=[];a.forEach(n=>{o.push({id:n.id,...n.data()})}),K(o)}catch(e){console.error("Error fetching courses:",e)}},V=async()=>{try{const e=y(p,"users"),t=k(e,A("role","==","student")),o=(await N(t)).docs.map(n=>({id:n.id,email:n.data().email,displayName:n.data().displayName||n.data().email,photoURL:n.data().photoURL,phoneNumber:n.data().phoneNumber,address:n.data().address,bio:n.data().bio}));Q(o)}catch(e){console.error("Error fetching students:",e),l("Failed to load students. Please try refreshing the page.")}},P=(e=null)=>{e?(v(e),h({name:e.name,description:e.description,courseId:e.courseId,studentIds:e.studentIds||[]})):(v(null),h({name:"",description:"",courseId:null,studentIds:[]})),q(!0),O(0)},w=()=>{q(!1),v(null),l("")},_=async()=>{try{if(console.log("Starting class submission...",{formData:r,currentUser:i}),!r.name){l("Class name is required");return}const e=Array.isArray(r.studentIds)?r.studentIds:[],t=j.filter(a=>e.includes(a.id));if(console.log("Student validation:",{providedIds:e,validStudents:t.map(a=>({id:a.id,name:a.name})),allStudents:j.map(a=>({id:a.id,name:a.name}))}),e.length!==t.length){l("Some selected users are not valid students");return}if(r.courseId){const a=I.some(o=>o.id===r.courseId);if(console.log("Course validation:",{courseId:r.courseId,exists:a}),!a){l("Selected course is not valid");return}}if(g){console.log("Updating existing class:",g.id);const a=H(p,"classes",g.id),o=await de(a);if(console.log("Fetched class document:",{exists:o.exists(),data:o.exists()?o.data():null}),!o.exists()){l("Class not found");return}const n=o.data();if(console.log("Permission check:",{teacherId:n.teacherId,currentUserId:i.uid,userRole:i.role,hasPermission:n.teacherId===i.uid||i.role==="admin"}),n.teacherId!==i.uid&&i.role!=="admin"){l("You do not have permission to update this class");return}const F={...n,name:r.name.trim(),description:(r.description||"").trim(),courseId:r.courseId||null,studentIds:t.map(oe=>oe.id),updatedAt:new Date().toISOString()};console.log("Updating with data:",F),await ce(a,F),console.log("Update successful")}else{console.log("Creating new class");const a={name:r.name.trim(),teacherId:i.uid,description:(r.description||"").trim(),courseId:r.courseId||null,studentIds:t.map(o=>o.id),createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};console.log("Creating with data:",a),await ue(y(p,"classes"),a),console.log("Creation successful")}w(),D()}catch(e){console.error("Error saving class:",{error:e,errorCode:e.code,errorMessage:e.message,errorDetails:e.details}),l("Failed to save class: "+e.message)}},ee=async e=>{try{await me(H(p,"classes",e)),D()}catch(t){console.error("Error deleting class:",t),l("Failed to delete class")}},se=e=>{const t=I.find(a=>a.id===e);return t?t.title:"No course assigned"},te=()=>s.jsx(he,{children:r.studentIds.map(e=>{var a;const t=j.find(o=>o.id===e);return t?s.jsxs(we,{children:[s.jsx(Ae,{children:s.jsx(T,{src:t.photoURL,alt:t.displayName,children:(a=t.displayName)==null?void 0:a.charAt(0)})}),s.jsx(pe,{primary:t.displayName,secondary:s.jsx(u,{variant:"body2",color:"text.secondary",children:t.email})}),s.jsx(ke,{children:s.jsx(L,{edge:"end","aria-label":"remove student",onClick:()=>re(e),children:s.jsx(M,{})})})]},e):null})}),ae=()=>s.jsx(J,{multiple:!0,value:j.filter(e=>r.studentIds.includes(e.id)),options:j,getOptionLabel:e=>e.displayName,renderInput:e=>s.jsx(b,{...e,label:"Select Students",placeholder:"Search students...",variant:"outlined"}),renderOption:(e,t)=>{var a;return s.jsxs(c,{component:"li",...e,children:[s.jsx(T,{src:t.photoURL,alt:t.displayName,sx:{width:24,height:24,mr:1},children:(a=t.displayName)==null?void 0:a.charAt(0)}),s.jsxs(c,{children:[s.jsx(u,{children:t.displayName}),s.jsx(u,{variant:"caption",color:"text.secondary",children:t.email})]})]})},renderTags:(e,t)=>e.map((a,o)=>{var n;return d.createElement(E,{...t({index:o}),key:a.id,avatar:s.jsx(T,{src:a.photoURL,alt:a.displayName,children:(n=a.displayName)==null?void 0:n.charAt(0)}),label:a.displayName,size:"small"})}),onChange:(e,t)=>{h({...r,studentIds:t.map(a=>a.id)})},sx:{width:"100%",mb:2}}),re=e=>{h({...r,studentIds:r.studentIds.filter(t=>t!==e)})};return s.jsxs(xe,{maxWidth:"lg",sx:{mt:4,mb:4,minHeight:"100vh",backgroundColor:m.palette.background.default,color:m.palette.text.primary},children:[s.jsxs(c,{sx:{mb:4},children:[s.jsxs(z,{direction:"row",justifyContent:"space-between",alignItems:"center",spacing:2,children:[s.jsx(u,{variant:"h4",children:"Classes"}),s.jsxs(z,{direction:"row",spacing:2,children:[s.jsx(f,{component:$,to:"/sessions/history",startIcon:s.jsx(G,{}),variant:"outlined",children:"Session History"}),s.jsx(f,{variant:"contained",startIcon:s.jsx(je,{}),onClick:()=>P(),children:"Add Class"})]})]}),s.jsx(Y,{container:!0,spacing:3,children:x.map(e=>{var t;return s.jsx(Y,{item:!0,xs:12,md:6,children:s.jsx(ge,{component:Ie.div,whileHover:{scale:1.02},whileTap:{scale:.98},sx:{backgroundColor:m.palette.background.paper,color:m.palette.text.primary},children:s.jsxs(fe,{children:[s.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",mb:2},children:[s.jsx(u,{variant:"h6",children:e.name}),s.jsxs(c,{children:[s.jsx(f,{size:"small",startIcon:s.jsx(G,{}),component:$,to:`/sessions/history?class=${e.id}`,sx:{mr:1},children:"View History"}),s.jsx(L,{size:"small",onClick:()=>P(e),sx:{mr:1},children:s.jsx(Ce,{})}),s.jsx(L,{size:"small",onClick:()=>ee(e.id),children:s.jsx(M,{})})]})]}),s.jsx(u,{color:"textSecondary",gutterBottom:!0,children:e.description}),s.jsxs(c,{sx:{mt:2},children:[s.jsx(E,{icon:s.jsx(W,{}),label:se(e.courseId),sx:{mr:1}}),s.jsx(E,{icon:s.jsx(le,{}),label:`${((t=e.studentIds)==null?void 0:t.length)||0} Students`})]})]})})},e.id)})})]}),s.jsxs(ye,{open:X,onClose:w,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{backgroundColor:m.palette.background.paper,color:m.palette.text.primary}},children:[s.jsx(be,{children:g?"Edit Class":"Create New Class"}),s.jsxs(Se,{children:[s.jsx(c,{sx:{borderBottom:1,borderColor:"divider"},children:s.jsxs(De,{value:C,onChange:(e,t)=>O(t),children:[s.jsx(R,{label:"Basic Info"}),s.jsx(R,{label:"Course"}),s.jsx(R,{label:"Students"})]})}),B&&s.jsx(u,{color:"error",sx:{mt:2},children:B}),s.jsxs(U,{value:C,index:0,children:[s.jsx(b,{fullWidth:!0,label:"Class Name",value:r.name,onChange:e=>h({...r,name:e.target.value}),sx:{mb:2}}),s.jsx(b,{fullWidth:!0,label:"Description",value:r.description,onChange:e=>h({...r,description:e.target.value}),multiline:!0,rows:3})]}),s.jsx(U,{value:C,index:1,children:s.jsx(J,{options:I,getOptionLabel:e=>e.title,value:I.find(e=>e.id===r.courseId)||null,onChange:(e,t)=>h({...r,courseId:(t==null?void 0:t.id)||null}),renderInput:e=>s.jsx(b,{...e,label:"Select Course"}),renderOption:(e,t)=>{const{key:a,...o}=e;return s.jsx("li",{...o,children:s.jsxs(c,{sx:{display:"flex",alignItems:"center"},children:[s.jsx(W,{sx:{mr:1}}),s.jsxs(c,{children:[s.jsx(u,{variant:"body1",children:t.title}),s.jsx(u,{variant:"caption",color:"text.secondary",children:t.description})]})]})},t.id)}})}),s.jsxs(U,{value:C,index:2,children:[ae(),te()]})]}),s.jsxs(ve,{children:[s.jsx(f,{onClick:w,children:"Cancel"}),s.jsx(f,{onClick:_,variant:"contained",children:g?"Update":"Create"})]})]})]})};export{es as default};
